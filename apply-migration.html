<!DOCTYPE html>
<html>
<head>
  <title>Apply RLS Migration</title>
</head>
<body>
  <h1>Applying RLS Migration...</h1>
  <pre id="output"></pre>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const supabaseUrl = 'https://zheoktbndihvfmtakzfs.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpoZW9rdGJuZGlodmZtdGFremZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MzE5NDMsImV4cCI6MjA3NjEwNzk0M30.S9iSrLTKDRrGLwUxJV37Vk_JmSIU3u9P0szH5pc5Z60';

    const supabase = createClient(supabaseUrl, supabaseKey);
    const output = document.getElementById('output');

    async function applyMigration() {
      const sql = `
-- Drop existing policies for stock_transfers
DROP POLICY IF EXISTS "Authenticated users can read stock transfers" ON stock_transfers;
DROP POLICY IF EXISTS "Authenticated users can insert stock transfers" ON stock_transfers;
DROP POLICY IF EXISTS "Authenticated users can update stock transfers" ON stock_transfers;
DROP POLICY IF EXISTS "Authenticated users can delete stock transfers" ON stock_transfers;

-- Drop existing policies for retailer_inventory
DROP POLICY IF EXISTS "Authenticated users can read retailer inventory" ON retailer_inventory;
DROP POLICY IF EXISTS "Authenticated users can insert retailer inventory" ON retailer_inventory;
DROP POLICY IF EXISTS "Authenticated users can update retailer inventory" ON retailer_inventory;
DROP POLICY IF EXISTS "Authenticated users can delete retailer inventory" ON retailer_inventory;

-- Create new policies for stock_transfers (allow anon access)
CREATE POLICY "Allow anon to read stock transfers"
  ON stock_transfers FOR SELECT
  TO anon
  USING (true);

CREATE POLICY "Allow anon to insert stock transfers"
  ON stock_transfers FOR INSERT
  TO anon
  WITH CHECK (true);

CREATE POLICY "Allow anon to update stock transfers"
  ON stock_transfers FOR UPDATE
  TO anon
  USING (true)
  WITH CHECK (true);

CREATE POLICY "Allow anon to delete stock transfers"
  ON stock_transfers FOR DELETE
  TO anon
  USING (true);

-- Create new policies for retailer_inventory (allow anon access)
CREATE POLICY "Allow anon to read retailer inventory"
  ON retailer_inventory FOR SELECT
  TO anon
  USING (true);

CREATE POLICY "Allow anon to insert retailer inventory"
  ON retailer_inventory FOR INSERT
  TO anon
  WITH CHECK (true);

CREATE POLICY "Allow anon to update retailer inventory"
  ON retailer_inventory FOR UPDATE
  TO anon
  USING (true)
  WITH CHECK (true);

CREATE POLICY "Allow anon to delete retailer inventory"
  ON retailer_inventory FOR DELETE
  TO anon
  USING (true);
      `;

      output.textContent = 'Executing SQL...\\n';

      try {
        const { data, error } = await supabase.rpc('exec_sql', { sql });

        if (error) {
          output.textContent += 'Error: ' + JSON.stringify(error, null, 2);
        } else {
          output.textContent += 'Success! Migration applied.\\n';
          output.textContent += JSON.stringify(data, null, 2);
        }
      } catch (e) {
        output.textContent += 'Exception: ' + e.message;
      }
    }

    applyMigration();
  </script>
</body>
</html>
